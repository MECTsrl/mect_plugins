# -----------------------------------------------------------------------------
# MectSuite Qt Embedded SDK builder
#
# - Windows host + i.MX28 target --> https://github.com/MECTsrl/mect_plugins/tree/mect_suite_3.5/build_win_env
#
# Prerequisites:
# - Debian/GNU Linux 10.0/Buster amd64 (schroot, cdeboostrap)
# - apt-get install make wget sudo aptitude
#
# Make targets for GNU/Linux Debian 10/amd64
# - desktop target --> make -f Makefile_desktop target  (toolchain)

# -----------------------------------------------------------------------------
include Makefile_common

# -----------------------------------------------------------------------------
.PHONY: toolchain clean_toolchain distclean_toolchain

# https://doc.qt.io/archives/qt-4.8/requirements-x11.html
# 	libfontconfig1-dev libfreetype6-dev libx11-dev libxcursor-dev libxext-dev libxfixes-dev libxft-dev libxi-dev libxrandr-dev libxrender-dev

MECT_PACKAGES:= \
	g++ \
	libfontconfig1-dev libfreetype6-dev libx11-dev libxcursor-dev libxext-dev libxfixes-dev libxft-dev libxi-dev libxrandr-dev libxrender-dev \
	libsqlite3-dev \
	libglib2.0-dev \
	gdb gdbserver
	# NB: no libssl-dev, it's openssl1.1

toolchain: 
	sudo aptitude install $(MECT_PACKAGES)
	@echo "---------> done $@"

clean_toolchain: 
	sudo aptitude remove $(MECT_PACKAGES)
	@echo "---------> done $@"

distclean_toolchain: 
	sudo aptitude purge $(MECT_PACKAGES)
	@echo "---------> done $@"

# -----------------------------------------------------------------------------
.PHONY: target clean_target distclean_target

MECT_PREFIX  := /opt/qt-desktop-$(MECT_SUITE_QT)
MECT_SOURCES := $(CURDIR)/src_desktop

# --------- OpenSSL 1.0 --------- 

$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Configure:
	mkdir -p $(MECT_SOURCES)
	tar -C $(MECT_SOURCES) -xzvf $(MECT_DOWNLOADF)/openssl-$(MECT_SUITE_OPENSSL).tar.gz
	rm -f $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile # NB: there was an old Makefile :(
	@echo "---------> done $@"

$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile: $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Configure
	cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && ./Configure \
		--prefix=$(MECT_PREFIX) \
		linux-generic32 shared no-asm -DL_ENDIAN
	@echo "---------> done $@"

$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/libssl.so.$(MECT_SUITE_OPENSSL_X): $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile
	+cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && make -j $(shell nproc) # NB: +
	@echo "---------> done $@"

$(MECT_PREFIX)/lib/libssl.so.$(MECT_SUITE_OPENSSL_X): $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/libssl.so.$(MECT_SUITE_OPENSSL_X)
	cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && sudo make install
	@echo "---------> done $@"

# --------- Qt --------- 

$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/configure:
	mkdir -p $(MECT_SOURCES)
	tar -C $(MECT_SOURCES) -xzvf $(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT).tar.gz
	# NB: no cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 <$(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1394522957.patch
	# NB: no cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 <$(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1420823825.patch
	# NB: no cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 <$(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1420823826.patch
	#
	# https://stackoverflow.com/questions/10354371/stdtr1-has-not-been-declared
	# https://bugreports.qt.io/browse/QTBUG-41361#comment-257906
	# also ./src/3rdparty/javascriptcore/JavaScriptCore/JavaScriptCore.pri
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) &&  \
		echo "QMAKE_CXXFLAGS = \$$\$$QMAKE_CFLAGS -std=gnu++98 -Wno-error=class-memaccess" \
	      	>> ./mkspecs/linux-g++/qmake.conf
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/Makefile: $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/configure
	# NB no: -no-vcproj -no-cetest -no-dsp: invalid command-line switch
	# FIXME dopo: -qt-sql-odbc -plugin-sql-odbc -plugin-sql-mysql
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && ./configure \
		-prefix $(MECT_PREFIX) \
		-platform linux-g++ \
	        -fast \
	        -opensource -confirm-license \
		-no-s60 -no-webkit -no-phonon -no-phonon-backend \
	        -no-qt3support \
	        -nomake examples -nomake demos \
		-qt-zlib \
	        -openssl -I $(MECT_PREFIX)/include \
		-qt-sql-sqlite -plugin-sql-sqlite \
		\
		-silent
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/lib/libQtCore.so.$(MECT_SUITE_QT): $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/Makefile
	+cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && make -j $(shell nproc) # NB: +
	@echo "---------> done $@"

$(MECT_PREFIX)/lib/libQtCore.so.$(MECT_SUITE_QT): $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/lib/libQtCore.so.$(MECT_SUITE_QT)
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && sudo make install
	@echo "---------> done $@"

# --------- QtCreator --------- 

$(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/qtcreator.pro:
	mkdir -p $(MECT_SOURCES)
	tar -C $(MECT_SOURCES) -xzvf $(MECT_DOWNLOADF)/qt-creator-$(MECT_SUITE_QTCREATOR)-src.tar.gz
	# cd $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src && patch -p1 <$(MECT_DOWNLOADF)/qt-creator-$(MECT_SUITE_QTCREATOR)-src-XXXXXXX.patch
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/Makefile: $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/qtcreator.pro
	cd $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/ && $(MECT_PREFIX)/bin/qmake -r \
		-silent
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/bin/qtcreator: $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/Makefile
	+cd $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/ && make -j $(shell nproc) # NB: +
	@echo "---------> done $@"

$(MECT_PREFIX)/bin/qtcreator: $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/bin/qtcreator
	cd $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/ && sudo make INSTALL_ROOT=$(MECT_PREFIX) install
	@echo "---------> done $@"

# --------- Qt Desktop --------- 

target: downloads toolchain \
	$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Configure \
	$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile \
	$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/libssl.so.$(MECT_SUITE_OPENSSL_X) \
	$(MECT_PREFIX)/lib/libssl.so.$(MECT_SUITE_OPENSSL_X) \
	\
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/configure \
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/Makefile \
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/lib/libQtCore.so.$(MECT_SUITE_QT) \
	$(MECT_PREFIX)/lib/libQtCore.so.$(MECT_SUITE_QT) \
	\
	$(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/qtcreator.pro \
	$(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/Makefile \
	$(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/bin/qtcreator \
	$(MECT_PREFIX)/bin/qtcreator \
	#
	@echo "---------> done $@"

clean_target: # clean_toolchain
	cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && make clean
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && make confclean
	cd $(MECT_SOURCES)/qt-creator-$(MECT_SUITE_QTCREATOR)-src/ && make confclean
	@echo "---------> done $@"

distclean_target: # distclean_toolchain
	rm -rf $(MECT_SOURCES)
	sudo rm -rf $(MECT_PREFIX)
	@echo "---------> done $@"

# -----------------------------------------------------------------------------
