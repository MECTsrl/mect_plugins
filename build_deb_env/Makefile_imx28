# -----------------------------------------------------------------------------
# MectSuite Qt Embedded SDK builder (i.MX28 Mect TP/TPAC target)
#
# vedi ./Makefile

include Makefile_common

# ----------------------------------------------------------------------------- i.MX28 target --------- 
.PHONY: all clean_all distclean_all

MECT_PREFIX  := /opt/Qt$(MECT_SUITE_QT)/imx28# NB: no MECT_PREFIX  := /opt/Trolltech
MECT_SOURCES := $(CURDIR)/src_imx28
MECT_PATCHES := $(CURDIR)/patches

all: \
	downloads toolchain \
	qt \
	\
	## NB: no qwt qt_plugins openssl
	@echo "---------> done $@"

clean_all: clean_toolchain
	cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && make clean
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && make confclean
	@echo "---------> done $@"

distclean_all: distclean_toolchain
	rm -rf $(MECT_SOURCES)
	sudo rm -rf $(MECT_PREFIX)
	@echo "---------> done $@"

# ----------------------------------------------------------------------------- i.MX28 cross toolchain --------- 
.PHONY: toolchain clean_toolchain distclean_toolchain

export MECT_CODESOURCERY_DIR := /opt/CodeSourcery
export MECT_CODESOURCERY_PRE := arm-2011.03

MECT_CROSS_COMPILE := $(MECT_CODESOURCERY_DIR)/bin/arm-none-linux-gnueabi-

# https://doc.qt.io/archives/qt-4.8/requirements-x11.html
# 	libfontconfig1-dev libfreetype6-dev libx11-dev libxcursor-dev libxext-dev libxfixes-dev libxft-dev libxi-dev libxrandr-dev libxrender-dev
MECT_PACKAGES:= \
	rsync wget \
	unzip \
	libc6:i386 \
	gdbserver
	# NB: no libssl-dev, it's openssl1.1
	# NB: no libqwt-dev, it's qwt6.1.4-1

toolchain: packages $(MECT_CODESOURCERY_DIR)/bin/arm-none-linux-gnueabi-g++ $(MECT_PREFIX)/rootfs/usr/lib/libc.so
	@echo "---------> done $@"

packages:
	# prepare multi-arch i386 on amd64
	sudo dpkg --add-architecture i386
	sudo apt-get update
	# install amd64 and i386 packages 
	sudo aptitude install $(MECT_PACKAGES)
	@echo "---------> done $@"

$(MECT_CODESOURCERY_DIR)/bin/arm-none-linux-gnueabi-g++:
	# NB: these are i386 executables
	sudo rm -rf /opt/$(MECT_CODESOURCERY_PRE) $(MECT_CODESOURCERY_DIR)
	sudo tar -C /opt -xjf $(MECT_DOWNLOADF)/arm-2011.03-41-arm-none-linux-gnueabi-i686-pc-linux-gnu.tar.bz2
	sudo mv /opt/$(MECT_CODESOURCERY_PRE) $(MECT_CODESOURCERY_DIR)
	@echo "---------> done $@"

$(MECT_PREFIX)/rootfs/usr/lib/libc.so:
	sudo mkdir -p $(MECT_PREFIX)
	# sudo unzip -d $(MECT_PREFIX) $(MECT_DOWNLOADF)/rootfs_dev_$(MECT_SUITE_RELEASE).zip
	sudo tar -C $(MECT_PREFIX) -xzf $(MECT_DOWNLOADF)/rootfs_dev_$(MECT_SUITE_RELEASE).tar.gz
	@echo "---------> done $@"

clean_toolchain: 
	# sudo aptitude remove $(MECT_PACKAGES)
	sudo rm -rf /opt/$(MECT_CODESOURCERY_PRE) $(MECT_CODESOURCERY_DIR)
	@echo "---------> done $@"

distclean_toolchain: 
	# sudo aptitude purge $(MECT_PACKAGES)
	sudo rm -rf /opt/$(MECT_CODESOURCERY_PRE) $(MECT_CODESOURCERY_DIR)
	@echo "---------> done $@"

# ----------------------------------------------------------------------------- OpenSSL 1.0 --------- 
#	.PHONY: openssl
#	
#	openssl: \
#		$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Configure \
#		$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile \
#		$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/libssl.so.$(MECT_SUITE_OPENSSL_X) \
#		$(MECT_PREFIX)/lib/libssl.so.$(MECT_SUITE_OPENSSL_X)
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Configure:
#		mkdir -p $(MECT_SOURCES)
#		tar -C $(MECT_SOURCES) -xzf $(MECT_DOWNLOADF)/openssl-$(MECT_SUITE_OPENSSL).tar.gz
#		rm -f $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile # NB: there was an old Makefile :(
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile: $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Configure
#		cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && ./Configure \
#			--cross-compile-prefix=$(MECT_CROSS_COMPILE) \
#			--prefix=$(MECT_PREFIX) \
#			linux-generic32 shared no-asm -DL_ENDIAN
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/libssl.so.$(MECT_SUITE_OPENSSL_X): $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/Makefile
#		+cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && make -j $(shell nproc) # NB: +
#		@echo "---------> done $@"
#	
#	$(MECT_PREFIX)/lib/libssl.so.$(MECT_SUITE_OPENSSL_X): $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/libssl.so.$(MECT_SUITE_OPENSSL_X)
#		cd $(MECT_SOURCES)/openssl-$(MECT_SUITE_OPENSSL)/ && sudo make install_sw
#		@echo "---------> done $@"
	
# ----------------------------------------------------------------------------- Qt --------- 
.PHONY: qt

MECT_QT_EMBEDDED  := arm
MECT_QT_ARCH      := arm
MECT_QT_PLATFORM  := linux-g++
MECT_QT_XPLATFORM := qws/linux-g++-mx

qt: \
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/configure \
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/Makefile \
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/bin/qmake \
	$(MECT_PREFIX)/bin/qmake \
	$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/lib/libQtCore.so.$(MECT_SUITE_QT) \
	$(MECT_PREFIX)/lib/libQtCore.so.$(MECT_SUITE_QT)
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/configure:
	mkdir -p $(MECT_SOURCES)
	tar -C $(MECT_SOURCES) -xzf $(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT).tar.gz
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 <$(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1394522957.patch
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 <$(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1420823825.patch
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 <$(MECT_DOWNLOADF)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1420823826.patch
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT) && patch -p1 < $(MECT_PATCHES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT).patch
	mkdir -p $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/mkspecs/$(MECT_QT_XPLATFORM)
	cp $(MECT_PATCHES)/$(MECT_QT_XPLATFORM)/qmake.conf      $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/mkspecs/$(MECT_QT_XPLATFORM)/qmake.conf
	cp $(MECT_PATCHES)/$(MECT_QT_XPLATFORM)/qplatformdefs.h $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/mkspecs/$(MECT_QT_XPLATFORM)/qplatformdefs.h
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/bin/qmake \
$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/Makefile: $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/configure
	# https://doc.qt.io/archives/qt-4.8/configure-options.html
	# vedi qt_configure_help.txt vs qt_configure_embedded_help.txt
	#
	# qt-everywhere-opensource-src-4.8.7/doc/src/network-programming/ssl.qdoc
	# OPENSSL_LIBS='-L$(MECT_PREFIX)/ssl/lib -lssl -lcrypto'
	#
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ \
		&& ./configure -v \
		-prefix $(MECT_PREFIX) -prefix-install \
		\
		-release \
		-opensource -confirm-license \
	        -shared \
		-no-fast \
		-no-largefile \
		-no-system-proxies \
		-no-exceptions \
	        -no-accessibility \
		-no-stl \
		-qt-sql-sqlite \
		-qt-sql-odbc \
		-qt-sql-mysql \
	        -no-qt3support \
		-no-xmlpatterns \
		-no-multimedia \
		-audio-backend \
		-no-phonon -no-phonon-backend \
		-no-svg \
		-no-webkit \
		-no-javascript-jit \
		-no-script \
		-no-scripttools \
		-no-declarative \
		-no-declarative-debug \
		-platform $(MECT_QT_PLATFORM) \
		\
		-no-3dnow \
		-no-mmx \
		-no-sse \
		-no-sse2 \
		-no-sse3 \
		-no-ssse3 \
		\
		-qt-zlib \
		-no-libtiff \
		-qt-libpng \
		-no-libmng \
		-qt-libjpeg \
		-openssl -I $(MECT_PREFIX)/rootfs/usr/include -L $(MECT_PREFIX)/rootfs/usr/lib \
		-nomake examples -nomake demos \
		-rpath \
		-silent \
		-no-optimized-qmake \
		-no-nis \
		-no-cups \
		-iconv \
		-pch \
		-no-dbus \
		-no-separate-debug-info \
		\
		-embedded $(MECT_QT_EMBEDDED) \
		-xplatform $(MECT_QT_XPLATFORM) \
		-little-endian \
		-host-little-endian \
		-qt-freetype \
		-no-opengl \
		-depths 8,16,18,32 \
		-qt-gfx-qvfb \
		-qt-gfx-linuxfb \
		-qt-gfx-transformed \
		-qt-gfx-vnc \
		-qt-kbd-tty \
		-qt-mouse-linuxtp \
		-no-glib \
		\
		-no-s60 \
		-no-icu \
		# -fontconfig 
	@echo "---------> done $@"

$(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/lib/libQtCore.so.$(MECT_SUITE_QT): $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/Makefile
	+cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && make -j $(shell nproc) # NB: +
	@echo "---------> done $@"

$(MECT_PREFIX)/lib/libQtCore.so.$(MECT_SUITE_QT): $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/lib/libQtCore.so.$(MECT_SUITE_QT)
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && sudo make install
	@echo "---------> done $@"

$(MECT_PREFIX)/bin/qmake: $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/bin/qmake
	cd $(MECT_SOURCES)/qt-everywhere-opensource-src-$(MECT_SUITE_QT)/ && sudo make install_qmake
	@echo "---------> done $@"

# ----------------------------------------------------------------------------- QWT --------- 
#	.PHONY: qwt
#	
#	qwt: \
#		$(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/qwt.pro \
#		$(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/Makefile \
#		$(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/lib/libqwt.so.$(MECT_SUITE_QWT_X) \
#		$(MECT_PREFIX)/lib/libqwt.so.$(MECT_SUITE_QWT_X)
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/qwt.pro:
#		mkdir -p $(MECT_SOURCES)
#		tar -C $(MECT_SOURCES) -xjf $(MECT_DOWNLOADF)/qwt-$(MECT_SUITE_QWT).tar.bz2
#		cd $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/ && patch -p1 < $(MECT_PATCHES)/qwt_embedded_imx28.patch
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/Makefile: $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/qwt.pro
#		cd $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/ && $(MECT_PREFIX)/bin/qmake qwt.pro -spec $(MECT_QT_XPLATFORM)
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/lib/libqwt.so.$(MECT_SUITE_QWT_X): $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/Makefile
#		# all: sub-src-all-ordered sub-textengines-all-ordered sub-doc-all-ordered sub-designer-all-ordered sub-examples-all-ordered FORCE
#		+cd $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/ && make sub-src-all-ordered sub-textengines-all-ordered -j $(shell nproc) # NB: +
#		@echo "---------> done $@"
#	
#	$(MECT_PREFIX)/lib/libqwt.so.$(MECT_SUITE_QWT_X): $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/lib/libqwt.so.$(MECT_SUITE_QWT_X)
#		cd $(MECT_SOURCES)/qwt-$(MECT_SUITE_QWT)/ && sudo make install # NB: no INSTALL_ROOT=$(MECT_PREFIX) vedi qwt.patch
#		@echo "---------> done $@"

# ----------------------------------------------------------------------------- ATCM target plugins --------- 
#	.PHONY: qt_plugins
#	
#	qt_plugins: \
#		$(MECT_SOURCES)/qt_atcm.pro \
#		$(MECT_SOURCES)/Makefile \
#		$(MECT_SOURCES)/qt_plugins/libATCMplugin.so.1.0.0 \
#		$(MECT_PREFIX)/plugins/libATCMplugin.so.1.0.0
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/qt_atcm.pro:
#		mkdir -p $(MECT_SOURCES)
#		rsync -Hax ../qt_plugins/ $(MECT_SOURCES)/qt_plugins/
#		rsync -Hax ../qt_library/ $(MECT_SOURCES)/qt_library/
#		cp -a ../qt_environment.pri ../qt_designer_environment.pri $(MECT_SOURCES)/
#		cp -a ../qt_atcm.pro $(MECT_SOURCES)/
#		cd $(MECT_SOURCES)/ && patch -p1 < $(MECT_PATCHES)/qt_plugins_embedded_host.patch # NB: no cd $(MECT_SOURCES)/qt_plugins/
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/Makefile: $(MECT_SOURCES)/qt_atcm.pro
#		cd $(MECT_SOURCES)/ \
#			&& $(MECT_PREFIX)/bin/qmake -r qt_atcm.pro \
#			   QT_INSTALL_PLUGINS=$(MECT_PREFIX)/plugins \
#			   -config store -config trend -config recipe -config alarms \
#			   CONFIG+=release DEFINES+=ATCM_VERSION=\"$(MECT_SUITE_RELEASE)\"
#		@echo "---------> done $@"
#	
#	$(MECT_SOURCES)/qt_plugins/libATCMplugin.so.1.0.0: $(MECT_SOURCES)/Makefile
#		#+cd $(MECT_SOURCES)/ && make -j $(shell nproc) # NB: +
#		cd $(MECT_SOURCES)/ && make -j1
#		@echo "---------> done $@"
#	
#	$(MECT_PREFIX)/plugins/libATCMplugin.so.1.0.0: $(MECT_SOURCES)/qt_plugins/libATCMplugin.so.1.0.0
#		sudo mkdir -p $(MECT_PREFIX)/plugins
#		cd $(MECT_SOURCES)/ && sudo make INSTALL_ROOT=$(MECT_PREFIX) install
#		@echo "---------> done $@"
	
# -----------------------------------------------------------------------------
