# -----------------------------------------------------------------------------
# MectSuite Qt Embedded SDK builder
# common declarations and rules

# -----------------------------------------------------------------------------

export LC_ALL := C

export MECT_SUITE_MAJOR   := 3
export MECT_SUITE_MINOR   := 5
export MECT_SUITE_BUILD   := 0
export MECT_SUITE_RELEASE := $(MECT_SUITE_MAJOR).$(MECT_SUITE_MINOR).$(MECT_SUITE_BUILD)

export MECT_BUILD_MAJOR := $(MECT_SUITE_MAJOR)
export MECT_BUILD_MINOR := $(MECT_SUITE_MINOR)
export MECT_BUILD_BUILD := $(MECT_SUITE_BUILD)
export MECT_BUILD_RELEASE := $(MECT_SUITE_MAJOR).$(MECT_SUITE_MINOR).$(MECT_SUITE_BUILD)

MECT_SUITE_QT        := 4.8.7
MECT_SUITE_QTCREATOR := 2.8.1

MECT_SUITE_QWT       := 6.1-multiaxes
MECT_SUITE_QWT_X     := 6.3.0

MECT_SUITE_OPENSSL   := 1.0.2u# 1.1.1w 3.0.13
MECT_SUITE_OPENSSL_X := 1.0.0# 1.1.0  3.0.0

MECT_SUITE_MYSQL     := 4.1.12
MECT_SUITE_MYSQL_X   := 14.0.0

# -----------------------------------------------------------------------------

.PHONY: downloads clean_downloads distclean_downloads

MECT_ARCHIVE_HOST := www.mect.it
MECT_ARCHIVE_HOST := localhost

MECT_DOWNLOADS := \
	qt-everywhere-opensource-src-$(MECT_SUITE_QT).tar.gz \
	qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1394522957.patch \
	qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1420823825.patch \
	qt-everywhere-opensource-src-$(MECT_SUITE_QT)-1420823826.patch \
	\
	qt-creator-$(MECT_SUITE_QTCREATOR)-src.tar.gz \
	\
	openssl-$(MECT_SUITE_OPENSSL).tar.gz \
	\
	mysql-$(MECT_SUITE_MYSQL).tar.gz \
	mysql-$(MECT_SUITE_MYSQL)-fsl.patch \
	mysql-$(MECT_SUITE_MYSQL)-gcc-4.2.patch \
	\
	qwt-$(MECT_SUITE_QWT).tar.bz2 \
	\
	arm-2011.03-41-arm-none-linux-gnueabi-i686-pc-linux-gnu.tar.bz2 \
	\
	rootfs_dev_$(MECT_SUITE_RELEASE).zip \
	#

# download files in downloads folder
MECT_DOWNLOADF := $(CURDIR)/downloads
MECT_DOWNLOADS := $(MECT_DOWNLOADS:%=$(MECT_DOWNLOADF)/%)

# for each download file consider file.md5 too
MECT_DOWNLOADSM := $(MECT_DOWNLOADS:%=%.md5)
MECT_DOWNLOADS  := $(MECT_DOWNLOADS) $(MECT_DOWNLOADSM)

# generic download rules

$(MECT_DOWNLOADF)/%.md5:
	@mkdir -p $(MECT_DOWNLOADF)
	@wget  -P $(MECT_DOWNLOADF) "http://$(MECT_ARCHIVE_HOST)/archive/$(@F)"
	@touch -c $@          # force the re-check of the downloaded file, if any
	@$(MAKE) -f $(firstword $(MAKEFILE_LIST)) $(@:%.md5=%) # re-check the downloaded file, if any

$(MECT_DOWNLOADF)/%: $(MECT_DOWNLOADF)/%.md5
	@mkdir -p $(MECT_DOWNLOADF)
	@cd       $(MECT_DOWNLOADF); md5sum -c $(@F).md5 2>/dev/null || { rm -f $(@F); wget "http://$(MECT_ARCHIVE_HOST)/archive/$(@F)"; md5sum -c $(@F).md5; }

downloads: $(MECT_DOWNLOADS)
	@echo "---------> done $@"

clean_downloads:
	rm -rf $(MECT_DOWNLOADF)/*.md5
	@echo "---------> done $@"

distclean_downloads:
	rm -rf $(MECT_DOWNLOADF)
	@echo "---------> done $@"

# -----------------------------------------------------------------------------
